@model dynamic
@{
    // int CallId = Model.CallId;
    // string IdSOT = Model.IdSolWor;
    // string CardCode = Model.CardCode;
}

<!-- Estilos y Librerías FullCalendar -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.4/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.4/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.4/locales/es.global.min.js"></script> <!-- Locale Español -->
<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- Bootstrap CSS y JS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">

<!-- DataTables CSS -->
<link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap4.min.css" rel="stylesheet">
<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap4.min.js"></script>

<style>
    body {
        font-family: 'Arial', sans-serif;
        margin: 0;
        padding: 10px;
        background-color: #f8f9fa;
    }

    .container-main {
        max-width: 98%;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        gap: 20px;
        align-items: stretch;
    }

    #calendar-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
        width: 100%;
    }

    #calendar, #table-container {
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        background: #fff;
        padding: 20px;
        flex: 1;
    }

    #calendar {
        width: 100%;
        height: 800px;
        overflow-y: auto;
    }

    #table-container {
        width: 100%;
        overflow-x: auto;
    }

    #simpletablePedAnt {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
    }

        #simpletablePedAnt th,
        #simpletablePedAnt td {
            padding: 8px 10px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        #simpletablePedAnt th {
            background-color: #007bff;
            color: white;
            font-weight: 600;
            font-size: 11px;
        }

        #simpletablePedAnt td {
            font-size: 11px;
            color: #333;
        }

        #simpletablePedAnt tr:hover {
            background-color: #f5f5f5;
            transition: background-color 0.3s ease;
        }

    .dataTables_filter input {
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 4px 8px;
        font-size: 12px;
        width: 200px;
    }

    .dataTables_length select {
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 4px;
        font-size: 12px;
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button {
        padding: 4px 8px;
        margin: 0 2px;
        border: 1px solid #007bff;
        border-radius: 4px;
        color: #007bff;
        font-size: 12px;
    }

        .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
            background-color: #007bff;
            color: white;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button.current {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }

    .card {
        border: none;
        border-radius: 8px;
    }

    .card-body {
        padding: 10px;
    }

    .mb-3 h1 {
        font-size: 1.4rem;
        margin-bottom: 10px;
        color: #007bff;
        font-weight: 600;
    }

    .modal-dialog {
        max-width: 600px;
    }

    .modal-content {
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        background: #fff;
    }

    .modal-header {
        background-color: #007bff;
        color: white;
        border-radius: 8px 8px 0 0;
        padding: 15px;
    }

    .modal-title {
        font-size: 1.2rem;
        font-weight: 600;
    }

    .modal-body {
        padding: 20px;
    }

        .modal-body label {
            font-weight: 600;
            color: #333;
            margin-bottom: 6px;
        }

        .modal-body .form-control {
            border-radius: 6px;
            padding: 8px;
            font-size: 12px;
            border: 1px solid #ccc;
        }

    .modal-footer {
        padding: 15px;
        border-top: none;
    }

    .btn-primary {
        background-color: #007bff;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 12px;
    }

    .btn-secondary {
        background-color: #6c757d;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 12px;
    }

    (max-width: 768px) {
        .container-main

    {
        padding: 5px;
        flex-direction: column;
    }

    #calendar-container {
        flex-direction: column;
    }

    #calendar, #table-container {
        width: 100%;
        padding: 10px;
    }

    #calendar {
        height: 400px;
    }

    #simpletablePedAnt th,
    #simpletablePedAnt td {
        padding: 6px 8px;
        font-size: 10px;
    }

    .modal-dialog {
        max-width: 90%;
    }

    .mb-3 h1 {
        font-size: 1.2rem;
    }

    }

    (max-width: 576px) {
        #calendar

    {
        height: 350px;
    }

    .modal-body {
        padding: 10px;
    }

    .modal-footer {
        flex-direction: column;
        gap: 8px;
    }

    }
</style>

<div class="container-main">
    <div id="calendar-container">
        <div id="calendar"></div>
    </div>
    <div id="table-container">
        <div class="mb-3">
            <h1>Actividades Preventivas</h1>
        </div>
        <div class="card">
            <div class="card-body">
                <div class="dt-responsive table-responsive">
                    <table id="simpletablePedAnt" class="table table-striped table-bordered table-hover">
                        <thead>
                            <tr>
                                <th>Número de Actividad</th>
                                <th>Fecha</th>
                                <th>Hora</th>
                                <th>#</th>
                                <th>CallId</th>
                                <th>LineNum</th>
                                <th>ClgId</th>
                                <th>Técnico</th>
                                <th>Actividad</th>
                                <th>Fecha Inicio</th>
                                <th>Hora Inicio</th>
                                <th>Fecha Fin</th>
                                <th>Hora Fin</th>
                                <th>Duración</th>
                                <th>Tiempo Real</th>
                                <th>Comentarios</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>1</td>
                                <td>2025-05-05</td>
                                <td>10:00</td>
                                <td>1</td>
                                <td>3</td>
                                <td>N/A</td>
                                <td>3</td>
                                <td>ejemplo</td>
                                <td>2025-11-11</td>
                                <td>12:22</td>
                                <td>2025-11-11</td>
                                <td>15:00</td>
                                <td>840</td>
                                <td>N/A</td>
                                <td>remarks</td>
                            </tr>
                            <tr>
                                <td>2</td>
                                <td>2025-05-06</td>
                                <td>12:00</td>
                                <td>2</td>
                                <td>3</td>
                                <td>1</td>
                                <td>4</td>
                                <td>coments</td>
                                <td>2025-12-12</td>
                                <td>12:26</td>
                                <td>2025-12-13</td>
                                <td>16:00</td>
                                <td>1240</td>
                                <td>N/A</td>
                                <td>remarks</td>
                            </tr>
                            <tr>
                                <td>3</td>
                                <td>2025-05-07</td>
                                <td>14:00</td>
                                <td>3</td>
                                <td>13</td>
                                <td>N/A</td>
                                <td>14</td>
                                <td>333rd</td>
                                <td>2025-12-12</td>
                                <td>12:24</td>
                                <td>2025-12-12</td>
                                <td>13:04</td>
                                <td>3600</td>
                                <td>N/A</td>
                                <td>Sin comentarios</td>
                            </tr>
                            <tr>
                                <td>4</td>
                                <td>2025-05-08</td>
                                <td>15:00</td>
                                <td>4</td>
                                <td>13</td>
                                <td>1</td>
                                <td>15</td>
                                <td>spdpow</td>
                                <td>2025-12-12</td>
                                <td>14:45</td>
                                <td>2025-12-12</td>
                                <td>15:05</td>
                                <td>3800</td>
                                <td>N/A</td>
                                <td>Sin comentarios</td>
                            </tr>
                            <tr>
                                <td>5</td>
                                <td>2025-05-09</td>
                                <td>16:00</td>
                                <td>5</td>
                                <td>13</td>
                                <td>2</td>
                                <td>16</td>
                                <td>ssss</td>
                                <td>2025-12-17</td>
                                <td>21:21</td>
                                <td>2025-12-17</td>
                                <td>13:21</td>
                                <td>3600</td>
                                <td>N/A</td>
                                <td>Sin comentarios</td>
                            </tr>
                            <tr>
                                <td>6</td>
                                <td>2025-05-10</td>
                                <td>17:00</td>
                                <td>6</td>
                                <td>13</td>
                                <td>3</td>
                                <td>17</td>
                                <td>pruebas</td>
                                <td>2025-12-19</td>
                                <td>21:44</td>
                                <td>2025-12-19</td>
                                <td>23:44</td>
                                <td>7200</td>
                                <td>N/A</td>
                                <td>Sin comentarios</td>
                            </tr>
                            <tr>
                                <td>7</td>
                                <td>2025-05-11</td>
                                <td>18:00</td>
                                <td>7</td>
                                <td>18</td>
                                <td>N/A</td>
                                <td>19</td>
                                <td>Sin título</td>
                                <td>2025-02-26</td>
                                <td>23:33</td>
                                <td>2025-02-26</td>
                                <td>23:36</td>
                                <td>900</td>
                                <td>N/A</td>
                                <td>Sin comentarios</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Actividades -->
<div class="modal fade" id="agregarActividadModal" tabindex="-1" aria-labelledby="agregarActividadModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="agregarActividadModalLabel">Agregar Actividad</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="tecnicoInput" class="form-label">Selecciona un Técnico:</label>
                    <input list="tecnico" id="tecnicoInput" class="form-control" placeholder="Selecciona o escribe un Técnico" required>
                    <datalist id="tecnico"></datalist>
                    <div class="invalid-feedback">Seleccione un técnico.</div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="fechaInicial" class="form-label">Fecha Inicial</label>
                        <input type="date" class="form-control" id="fechaInicial" required>
                        <div class="invalid-feedback">Ingrese la fecha inicial.</div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="horaInicial" class="form-label">Hora Inicial</label>
                        <input type="time" class="form-control" id="horaInicial" required>
                        <div class="invalid-feedback">Ingrese la hora inicial.</div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="horaFinal" class="form-label">Hora Final</label>
                        <input type="time" class="form-control" id="horaFinal" required>
                        <div class="invalid-feedback">Ingrese la hora final.</div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="tiempoPlaneado" class="form-label">Tiempo Planeado (minutos)</label>
                        <input type="number" class="form-control" id="tiempoPlaneado" placeholder="Calculado automáticamente" required readonly>
                        <div class="invalid-feedback">Ingrese el tiempo planeado.</div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="tiempoReal" class="form-label">Tiempo Real (minutos)</label>
                        <input type="number" class="form-control" id="tiempoReal" placeholder="Tiempo en minutos" required>
                        <div class="invalid-feedback">Ingrese el tiempo real.</div>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="comentarios" class="form-label">Comentarios</label>
                    <textarea class="form-control" id="comentarios" rows="4" placeholder="Escribe tus comentarios aquí" required></textarea>
                    <div class="invalid-feedback">Ingrese los comentarios.</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" id="guardarBtn">Guardar</button>
            </div>
        </div>
    </div>
</div>

<!-- Script para Inicializar FullCalendar, DataTable y Funcionalidades del Modal -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const calendarEl = document.getElementById('calendar');
        const modalEl = document.getElementById('agregarActividadModal');
        const closeModalBtn = document.querySelector('.btn-close');
        const saveActivityBtn = document.getElementById('guardarBtn');

        // Inicializar FullCalendar en Español
        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'es',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            buttonText: {
                today: 'Hoy',
                month: 'Mes',
                week: 'Semana',
                day: 'Día'
            },
            selectable: true,
            editable: true,
            height: '100%',
            contentHeight: 'auto',
            events: [
                {
                    title: 'Actividad 1',
                    start: '2025-05-05T10:00:00',
                    end: '2025-05-05T15:00:00',
                    backgroundColor: "#007bff",
                    extendedProps: {
                        tecnico: "ejemplo",
                        comentarios: "remarks",
                        callId: "3",
                        lineNum: "N/A",
                        clgId: "3",
                        duracion: "840",
                        tiempoReal: "N/A"
                    }
                },
                {
                    title: 'Actividad 2',
                    start: '2025-05-06T12:00:00',
                    end: '2025-05-06T16:00:00',
                    backgroundColor: "#007bff",
                    extendedProps: {
                        tecnico: "coments",
                        comentarios: "remarks",
                        callId: "3",
                        lineNum: "1",
                        clgId: "4",
                        duracion: "1240",
                        tiempoReal: "N/A"
                    }
                },
                {
                    title: 'Actividad 3',
                    start: '2025-05-07T14:00:00',
                    end: '2025-05-07T15:04:00',
                    backgroundColor: "#007bff",
                    extendedProps: {
                        tecnico: "333rd",
                        comentarios: "Sin comentarios",
                        callId: "13",
                        lineNum: "N/A",
                        clgId: "14",
                        duracion: "3600",
                        tiempoReal: "N/A"
                    }
                },
                {
                    title: 'Actividad 4',
                    start: '2025-05-08T15:00:00',
                    end: '2025-05-08T15:05:00',
                    backgroundColor: "#007bff",
                    extendedProps: {
                        tecnico: "spdpow",
                        comentarios: "Sin comentarios",
                        callId: "13",
                        lineNum: "1",
                        clgId: "15",
                        duracion: "3800",
                        tiempoReal: "N/A"
                    }
                },
                {
                    title: 'Actividad 5',
                    start: '2025-05-09T16:00:00',
                    end: '2025-05-09T13:21:00',
                    backgroundColor: "#007bff",
                    extendedProps: {
                        tecnico: "ssss",
                        comentarios: "Sin comentarios",
                        callId: "13",
                        lineNum: "2",
                        clgId: "16",
                        duracion: "3600",
                        tiempoReal: "N/A"
                    }
                },
                {
                    title: 'Actividad 6',
                    start: '2025-05-10T17:00:00',
                    end: '2025-05-10T23:44:00',
                    backgroundColor: "#007bff",
                    extendedProps: {
                        tecnico: "pruebas",
                        comentarios: "Sin comentarios",
                        callId: "13",
                        lineNum: "3",
                        clgId: "17",
                        duracion: "7200",
                        tiempoReal: "N/A"
                    }
                },
                {
                    title: 'Actividad 7',
                    start: '2025-05-11T18:00:00',
                    end: '2025-05-11T23:36:00',
                    backgroundColor: "#007bff",
                    extendedProps: {
                        tecnico: "Sin título",
                        comentarios: "Sin comentarios",
                        callId: "18",
                        lineNum: "N/A",
                        clgId: "19",
                        duracion: "900",
                        tiempoReal: "N/A"
                    }
                }
            ],
            dateClick: function (info) {
                const modal = new bootstrap.Modal(document.getElementById('agregarActividadModal'));
                modal.show();
            },
            eventClick: function (info) {
                const confirmDelete = confirm(`¿Deseas eliminar el evento "${info.event.title}"?`);
                if (confirmDelete) {
                    info.event.remove();
                    alert(`Evento "${info.event.title}" eliminado.`);
                    // Remove from DataTable as well
                    const rowData = table.rows().data().toArray().find(row => row[8] === info.event.title);
                    if (rowData) {
                        table.row(table.rows().data().toArray().indexOf(rowData)).remove().draw();
                    }
                }
            }
        });

        // Inicializar DataTable con los datos de la tabla
        var table = $('#simpletablePedAnt').DataTable({
            "language": {
                "decimal": ",",
                "thousands": ".",
                "lengthMenu": "Mostrar _MENU_ registros por página",
                "zeroRecords": "No se encontraron resultados",
                "info": "Mostrando _START_ a _END_ de _TOTAL_ registros",
                "infoEmpty": "Mostrando 0 a 0 de 0 registros",
                "infoFiltered": "(filtrado de _MAX_ registros totales)",
                "search": "Buscar:",
                "paginate": {
                    "first": "Primero",
                    "last": "Último",
                    "next": "Siguiente",
                    "previous": "Anterior"
                }
            },
            "paging": true,
            "searching": true,
            "ordering": true,
            "info": true,
            "autoWidth": false,
            "responsive": true,
            "data": [
                [1, "2025-05-05", "10:00", 1, "3", "N/A", "3", "ejemplo", "Actividad 1", "2025-11-11", "12:22", "2025-11-11", "15:00", "840", "N/A", "remarks"],
                [2, "2025-05-06", "12:00", 2, "3", "1", "4", "coments", "Actividad 2", "2025-12-12", "12:26", "2025-12-13", "16:00", "1240", "N/A", "remarks"],
                [3, "2025-05-07", "14:00", 3, "13", "N/A", "14", "333rd", "Actividad 3", "2025-12-12", "12:24", "2025-12-12", "13:04", "3600", "N/A", "Sin comentarios"],
                [4, "2025-05-08", "15:00", 4, "13", "1", "15", "spdpow", "Actividad 4", "2025-12-12", "14:45", "2025-12-12", "15:05", "3800", "N/A", "Sin comentarios"],
                [5, "2025-05-09", "16:00", 5, "13", "2", "16", "ssss", "Actividad 5", "2025-12-17", "21:21", "2025-12-17", "13:21", "3600", "N/A", "Sin comentarios"],
                [6, "2025-05-10", "17:00", 6, "13", "3", "17", "pruebas", "Actividad 6", "2025-12-19", "21:44", "2025-12-19", "23:44", "7200", "N/A", "Sin comentarios"],
                [7, "2025-05-11", "18:00", 7, "18", "N/A", "19", "Sin título", "Actividad 7", "2025-02-26", "23:33", "2025-02-26", "23:36", "900", "N/A", "Sin comentarios"]
            ],
            "columns": [
                { title: "Número de Actividad" },
                { title: "Fecha" },
                { title: "Hora" },
                { title: "#" },
                { title: "CallId" },
                { title: "LineNum" },
                { title: "ClgId" },
                { title: "Técnico" },
                { title: "Actividad" },
                { title: "Fecha Inicio" },
                { title: "Hora Inicio" },
                { title: "Fecha Fin" },
                { title: "Hora Fin" },
                { title: "Duración" },
                { title: "Tiempo Real" },
                { title: "Comentarios" }
            ]
        });

        // Cerrar el modal
        closeModalBtn.addEventListener('click', function () {
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();
        });

        // Guardar actividad
        saveActivityBtn.addEventListener('click', function () {
            const tecnico = document.getElementById('tecnicoInput').value;
            const fechaInicial = document.getElementById('fechaInicial').value;
            const horaInicial = document.getElementById('horaInicial').value;
            const horaFinal = document.getElementById('horaFinal').value;
            const tiempoReal = document.getElementById('tiempoReal').value;
            const comentarios = document.getElementById('comentarios').value;

            if (!tecnico || !fechaInicial || !horaInicial || !horaFinal || !tiempoReal || !comentarios) {
                Swal.fire('Error!', 'Todos los campos son obligatorios.', 'error');
                return;
            }

            const startTimeFormatted = convertirHora24(horaInicial);
            const endTimeFormatted = convertirHora24(horaFinal);

            // Calculate duration in minutes
            const startDateTime = new Date(`${fechaInicial}T${startTimeFormatted}:00`);
            const endDateTime = new Date(`${fechaInicial}T${endTimeFormatted}:00`);
            let duracion = (endDateTime - startDateTime) / (1000 * 60);
            if (duracion < 0) {
                duracion += 1440; // Handle cases where end time is past midnight
            }

            // Generate new activity number
            const currentRows = table.rows().data().toArray();
            const newActivityNumber = currentRows.length + 1;

            // Add event to FullCalendar
            const newEvent = {
                title: `Actividad ${newActivityNumber}`,
                start: `${fechaInicial}T${startTimeFormatted}`,
                end: `${fechaInicial}T${endTimeFormatted}`,
                backgroundColor: "#007bff",
                extendedProps: {
                    tecnico: tecnico,
                    comentarios: comentarios,
                    callId: "N/A",
                    lineNum: "N/A",
                    clgId: "N/A",
                    duracion: duracion.toString(),
                    tiempoReal: tiempoReal
                }
            };
            calendar.addEvent(newEvent);

            // Add row to DataTable
            table.row.add([
                newActivityNumber,
                fechaInicial,
                startTimeFormatted,
                newActivityNumber,
                "N/A",
                "N/A",
                "N/A",
                tecnico,
                `Actividad ${newActivityNumber}`,
                fechaInicial,
                startTimeFormatted,
                fechaInicial,
                endTimeFormatted,
                duracion.toString(),
                tiempoReal,
                comentarios
            ]).draw();

            // Show success message and close modal
            Swal.fire('Guardado!', 'La actividad ha sido guardada correctamente.', 'success').then(() => {
                const modal = bootstrap.Modal.getInstance(modalEl);
                modal.hide();
            });
        });

        function calcularTiempo() {
            let horaInicial = document.getElementById('horaInicial').value;
            let horaFinal = document.getElementById('horaFinal').value;
            let tiempoPlaneado = document.getElementById('tiempoPlaneado');

            if (horaInicial && horaFinal) {
                let inicio = new Date(`1970-01-01T${horaInicial}:00`);
                let fin = new Date(`1970-01-01T${horaFinal}:00`);
                let diferencia = (fin - inicio) / (1000 * 60);
                if (diferencia < 0) {
                    diferencia += 1440;
                }
                tiempoPlaneado.value = diferencia;
            } else {
                tiempoPlaneado.value = "";
            }
        }

        document.getElementById('horaInicial').addEventListener('change', calcularTiempo);
        document.getElementById('horaFinal').addEventListener('change', calcularTiempo);

        function convertirHora24(hora) {
            return hora || "00:00";
        }

        calendar.render();
    });
</script>